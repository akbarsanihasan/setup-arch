#!/usr/bin/env bash

clear

current_dir=$PWD

packaged() {
    sudo pacman -S --noconfirm --needed sway \
        swaybg \
        swaylock \
        swayidle
}

compiled() {
    local dependencies=(
        cairo
        gdk-pixbuf2
        json-c
        libdrm
        libevdev
        libinput
        libxcb
        libxkbcommon
        pango
        pcre2
        pixman
        xcb-util-wm
    )
    local build_dependencies=(
        git
        base-devel
        libcap
        meson
        cmake
        scdoc
        wayland-protocols
    )

    sudo pacman -S --noconfirm --needed "${dependencies[@]}" "${build_dependencies[@]}"

    local REPOS=(sway swaybg swaylock swayidle)
    local REPO_VERSIONS=(1.11 v1.2.1 v1.8.2 1.8.0)

    for i in ${!REPOS[@]}; do
        local DOWNLOAD_PATH=$current_dir/.cache/"${REPOS[$i]}"

        if ! [[ -d $DOWNLOAD_PATH ]]; then
            mkdir -p "$DOWNLOAD_PATH"
            git clone --recursive --depth 1 -b "${REPO_VERSIONS[$i]}" \
                https://github.com/swaywm/"${REPOS[$i]}" \
                "$DOWNLOAD_PATH"
        fi

        if [[ ${REPOS[$i]} == "sway" ]]; then
            if ! [[ -d $DOWNLOAD_PATH/subprojects/wlroots ]]; then
                git clone --recursive --depth 1 -b 0.19.0 https://gitlab.freedesktop.org/wlroots/wlroots.git "$DOWNLOAD_PATH"/subprojects/wlroots
            fi
            if ! [[ -d $DOWNLOAD_PATH/subprojects/libdisplay-info ]]; then
                git clone --recursive --depth 1 -b 0.2.0 https://gitlab.freedesktop.org/emersion/libdisplay-info.git "$DOWNLOAD_PATH"/subprojects/libdisplay-info
            fi
            if ! [[ -d $DOWNLOAD_PATH/subprojects/libliftoff ]]; then
                git clone --recursive --depth 1 -b v0.5.0 https://gitlab.freedesktop.org/emersion/libliftoff.git "$DOWNLOAD_PATH"/subprojects/libliftoff
            fi
            if ! [[ -d $DOWNLOAD_PATH/subprojects/libdrm ]]; then
                git clone --recursive --depth 1 -b libdrm-2.4.125 https://gitlab.freedesktop.org/mesa/drm.git "$DOWNLOAD_PATH"/subprojects/libdrm
            fi
            if ! [[ -d $DOWNLOAD_PATH/subprojects/seatd ]]; then
                git clone --recursive --depth 1 -b 0.9.1 https://git.sr.ht/~kennylevinsen/seatd "$DOWNLOAD_PATH"/subprojects/seatd
            fi
        fi

        cd "$DOWNLOAD_PATH"
        meson setup ./build --reconfigure \
            --prefix=/usr/local \
            --sysconfdir=/etc
        meson compile -C ./build
        sudo meson install -C ./build
    done
}

core=(wayland xorg-xwayland xdg-desktop-portal-wlr xdg-desktop-portal-gtk)
utilities=(wl-clipboard cliphist polkit-gnome libnotify brightnessctl playerctl xdg-user-dirs)

sudo pacman -S --noconfirm --needed "${core[@]}" "${utilities[@]}"
compiled

cd "$current_dir"
