#!/usr/bin/env bash

clear

current_dir=$PWD

mkdir -p "$HOME"/.config
mkdir -p "$HOME"/.cache
mkdir -p "$HOME"/.local/share
mkdir -p "$HOME"/.local/bin

sudo pacman -S --noconfirm --needed git

for config in "$PWD"/.dotfiles/{*,.*}; do
	basename_config=$(basename "$config")
	config_target="$HOME/$basename_config"

	if [[ $basename_config == "*" ]] || [[ $basename_config == ".*" ]]; then
		continue
	fi

	if [[ -L $config_target ]]; then
		rm -rf "$config_target"
	fi

	if [[ -f $config ]]; then
		echo "Linking config $config to $config_target"
		ln -sfn "$config" "$config_target"
		continue
	fi

	for subconfig in "$config"/{*,.*}; do
		basename_subconfig=$(basename "$subconfig")
		subconfig_target="$config_target/$basename_subconfig"

		if [[ $basename_subconfig == "*" ]] || [[ $basename_subconfig == ".*" ]]; then
			continue
		fi

		if [[ -L $subconfig_target ]]; then
			rm -rf "$subconfig_target"
		fi

		if [[ -f $subconfig ]]; then
			echo "Linking subconfig $subconfig to $subconfig_target"
			ln -svfn "$subconfig" "$subconfig_target"
			continue
		fi

		if [[ -d $subconfig ]] && ! [[ -e $subconfig_target ]]; then
			echo "Linking subconfig $subconfig to $subconfig_target"
			ln -svfn "$subconfig" "$subconfig_target"
			continue
		fi

		for node_subconfig in "$subconfig"/{*,.*}; do
			basename_node_subconfig=$(basename "$node_subconfig")
			node_subconfig_target="$subconfig_target/$basename_node_subconfig"

			if [[ $basename_node_subconfig == "*" ]] || [[ $basename_node_subconfig == ".*" ]]; then
				continue
			fi

			if [[ -L $node_subconfig_target ]]; then
				rm -rf "$node_subconfig_target"
			fi

			echo "Linking node_subconfig $node_subconfig to $node_subconfig_target"
			ln -svfn "$node_subconfig" "$node_subconfig_target"
		done
	done
done
