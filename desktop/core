#!/usr/bin/env bash

clear

current_dir=$PWD

mkdir -p "$HOME"/.config
mkdir -p "$HOME"/.cache
mkdir -p "$HOME"/.local/share
mkdir -p "$HOME"/.local/bin

for config in "$current_dir"/.dotfiles/{*,.*}; do
    basename_config=$(basename "$config")
    config_target="$HOME/$basename_config"

    if [[ $basename_config == "*" ]] || [[ $basename_config == ".*" ]]; then
        continue
    fi

    if [[ -L $config_target ]]; then
        rm -rf "$config_target"
    fi

    if [[ -f $config ]] || [[ ! -e $config_target ]]; then
        echo "Linking config $config to $config_target"
        ln -sfn "$config" "$config_target"
        continue
    fi

    for subconfig in "$config"/{*,.*}; do
        basename_subconfig=$(basename "$subconfig")
        subconfig_target="$config_target/$basename_subconfig"

        if [[ $basename_subconfig == "*" ]] || [[ $basename_subconfig == ".*" ]]; then
            continue
        fi

        if [[ -L $subconfig_target ]]; then
            rm -rf "$subconfig_target"
        fi

        if [[ -f $subconfig ]] || [ ! -e "$subconfig_target" ]; then
            echo "Linking subconfig $subconfig to $subconfig_target"
            ln -svfn "$subconfig" "$subconfig_target"
            continue
        fi

        for node_subconfig in "$subconfig"/{*,.*}; do
            basename_node_subconfig=$(basename "$node_subconfig")
            node_subconfig_target="$subconfig_target/$basename_node_subconfig"

            if [[ $basename_node_subconfig == "*" ]] || [[ $basename_node_subconfig == ".*" ]]; then
                continue
            fi

            if [[ -L $node_subconfig_target ]]; then
                rm -rf "$node_subconfig_target"
            fi

            echo "Linking node_subconfig $node_subconfig to $node_subconfig_target"
            ln -svfn "$node_subconfig" "$node_subconfig_target"
        done
    done
done

core=(git zsh tmux fzf btop fastfetch trash-cli man tldr)
apps=(foot mpv thunar file-roller okular ristretto mousepad pavucontrol blueman nm-connection-editor android-file-transfer)
apps_dependencies=(gvfs gvfs-mtp tumbler ffmpegthumbnailer webp-pixbuf-loader thunar-archive-plugin)
tools=(dconf fd jq ripgrep gawk less curl wget tar zip unzip unrar p7zip)

sudo pacman -S --noconfirm --needed "${core[@]}" \
    "${apps[@]}" \
    "${apps_deppendencies[@]}" \
    "${tools[@]}"

if ! [[ -e "$HOME"/.config/tmux/plugins/tpm ]]; then
    git clone https://github.com/tmux-plugins/tpm "$HOME"/.config/tmux/plugins/tpm
fi
"$HOME"/.config/tmux/plugins/tpm/bin/install_plugins all

/usr/bin/xdg-user-dirs-update
mkdir -p "$HOME"/.config/gtk-3.0/
tee "$HOME"/.config/gtk-3.0/bookmarks <<-EOF
	file:///home/$USER/Documents
	file:///home/$USER/Downloads
	file:///home/$USER/Music
	file:///home/$USER/Pictures
	file:///home/$USER/Public
	file:///home/$USER/Templates
	file:///home/$USER/Videos
EOF

dconf write /org/blueman/general/plugin-list "['!ShowConnected', '!StatusIcon']"
dconf write /org/gnome/desktop/wm/preferences/button-layout "':'"

sudo chsh -s "$(command -v zsh)" "$USER"

cd "$current_dir"
